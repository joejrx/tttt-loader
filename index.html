<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TTTT Loader – Prototype (Category Filter)</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.45; }
    .small { color:#555; margin-top: 4px; }
    .status {
      display:inline-block; padding:10px 12px; border-radius:8px; margin: 10px 0 18px;
      font-weight: 800;
    }
    .checking { background:#ffeeba; color:#7a5a00; }
    .running { background:#d4edda; color:#155724; }
    .error { background:#f8d7da; color:#721c24; }

    .controls {
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      margin: 10px 0 6px;
    }
    label { font-weight: 700; }
    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: #fff;
    }

    .wrap { overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 1600px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; vertical-align: top; }
    th { background:#efefef; position: sticky; top: 0; z-index: 2; }
    th.num, td.num { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
    th.txt, td.txt { text-align: left; }
  </style>
</head>

<body>
  <h1>CFalls Product Terpene Loader (Prototype)</h1>
  <div class="small">TTTT-style layout • Filter: Product Type • Default: Flower • Sort: Total Terpenes (desc), then BetaCaryphyllene (desc)</div>

  <div id="jsStatus" class="status checking">JS status: (checking…)</div>

  <div class="controls">
    <label for="categorySelect">Category:</label>
    <select id="categorySelect" aria-label="Category filter">
      <!-- populated by JS; NO "All" option -->
    </select>
  </div>

  <div class="wrap">
    <table id="tbl">
      <thead><tr id="hdrRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  var statusEl = document.getElementById("jsStatus");
  var categorySelect = document.getElementById("categorySelect");

  function setStatus(cls, msg) {
    statusEl.className = "status " + cls;
    statusEl.textContent = msg;
  }

  // ✅ prove JS ran immediately
  setStatus("running", "JS status: RUNNING ✅ (initializing…)");

  try {
    // ------------------------------------------------------------
    // 1) Canonical non-terp columns (TTTT order)
    // ------------------------------------------------------------
    var baseCols = [
      { key: "Product", label: "Product", type: "txt" },
      { key: "Location", label: "Location", type: "txt" },
      { key: "Product Type", label: "Product Type", type: "txt" },
      { key: "Room", label: "Room", type: "txt" },
      { key: "THC", label: "THC", type: "num_pct" },
      { key: "Total Terpenes", label: "Total Terpenes", type: "num_pct" }
    ];

    // ------------------------------------------------------------
    // 2) Canonical terp columns (exact order from desktop TTTT)
    // ------------------------------------------------------------
    var terpCols = [
      "BetaCaryphyllene",
      "Limonene",
      "Linalool",
      "BetaMyrcene",
      "Humulene",
      "Terpinolene",
      "BetaPinene",
      "AlphaPinene",
      "ThreeCarene",
      "AlphaTerpinene",
      "BetaEudesmol",
      "Bisabolol",
      "Camphene",
      "Eucalyptol",
      "Geraniol",
      "Guaiol",
      "Isopulegol",
      "Nerolidol",
      "NerolidolTwo",
      "Ocimene",
      "OcimeneOne",
      "OcimeneTwo",
      "pCymene",
      "pIsopropyltouluene",
      "Terpinene",
      "TransNerolidol"
    ];

    // Show blanks instead of 0.00% (matches export look)
    var BLANK_ZERO = true;

    function toNum(x) {
      var n = Number(x);
      return isFinite(n) ? n : 0;
    }

    function fmtPct(n) {
      var num = toNum(n);
      if (BLANK_ZERO && num === 0) return "";
      return num.toFixed(2) + "%"; // ✅ no space
    }

    // ------------------------------------------------------------
    // 3) Sample data (baked-in)
    // NOTE: Missing terp keys will be treated as 0.
    // Product Type values here are what the dropdown will use.
    // ------------------------------------------------------------
   // --------------
// PASTE CFALLS TSV HERE (header row + rows)
// --------------
var RAW_TSV = String.raw`Product    Location    Category    Room    THC    TotalTerpenes    BetaCaryphyllene    Limonene    Linalool    BetaMyrcene    Humulene    Terpinolene    BetaPinene    AlphaPinene    ThreeCarene    AlphaTerpinene    BetaEudesmol    Bisabolol    Camphene    Eucalyptol    Geraniol    Guaiol    Isopulegol    Nerolidol    NerolidolTwo    Ocimene    OcimeneOne    OcimeneTwo    pCymene    pIsopropyltouluene    Terpinene    TransNerolidol    Batch    Cannabinoid    CaryophylleneOxide
Rebel | Double OG CHM | 1g Live Resin Budder    Farmaceuticalrx (Cuyahoga Falls)    Budder    Sales Floor    666.0 mg/g        8.48 mg/g    30.5 mg/g    13.4 mg/g    28.7 mg/g    3.5 mg/g        4.11 mg/g    2.01 mg/g        0.02 mg/g        2.3 mg/g        0.0 mg/g                                                    1A407030000332D000023614        0.26 mg/g
Meigs County | LA Kush Cake | 14.15g Country Cut    Farmaceuticalrx (Cuyahoga Falls)    Flower    Sales Floor    22.9 %        0.67 %    0.73 %    0.24 %    0.6 %    0.2 %        0.12 %    0.06 %        0.0 %        0.06 %                                                            1A40703000000C9000006828        0.01 %
Pure Ohio Wellness | Gelato | 2.83g    Farmaceuticalrx (Cuyahoga Falls)    Flower    Sales Floor    26.3 %        0.91 %    0.91 %    0.48 %        0.35 %                                                                                        1A4070300002C25000019210        
... paste the rest of your rows ...
`;

    // ------------------------------------------------------------
    // 4) Compute Total Terpenes (addition step across canonical keys)
    // ------------------------------------------------------------
    for (var i = 0; i < data.length; i++) {
      var row = data[i];
      var total = 0;

      for (var t = 0; t < terpCols.length; t++) {
        var k = terpCols[t];
        row[k] = toNum(row[k]);  // normalize missing to 0
        total += row[k];
      }

      row["Total Terpenes"] = Math.round(total * 100) / 100;
    }

    // ------------------------------------------------------------
    // 5) Build header row once (TTTT order)
    // ------------------------------------------------------------
    var hdr = document.getElementById("hdrRow");
    var hdrHtml = "";

    for (var c = 0; c < baseCols.length; c++) {
      var isNum = baseCols[c].type.indexOf("num") === 0;
      hdrHtml += '<th class="' + (isNum ? "num" : "txt") + '">' + baseCols[c].label + '</th>';
    }
    for (var tc = 0; tc < terpCols.length; tc++) {
      hdrHtml += '<th class="num">' + terpCols[tc] + '</th>';
    }
    hdr.innerHTML = hdrHtml;

    // ------------------------------------------------------------
    // 6) Category filter dropdown (NO "ALL", default = Flower)
    // ------------------------------------------------------------
    function uniqueSorted(list) {
      var map = {};
      for (var j = 0; j < list.length; j++) map[list[j]] = true;
      var out = Object.keys(map);
      out.sort();
      return out;
    }

    var categories = uniqueSorted(data.map(function (r) { return r["Product Type"] || ""; }).filter(Boolean));

    // Populate select
    categorySelect.innerHTML = "";
    for (var k2 = 0; k2 < categories.length; k2++) {
      var opt = document.createElement("option");
      opt.value = categories[k2];
      opt.textContent = categories[k2];
      categorySelect.appendChild(opt);
    }

    // Default to Flower if present; otherwise first available
    var defaultCat = categories.indexOf("Flower") >= 0 ? "Flower" : (categories[0] || "");
    categorySelect.value = defaultCat;

    // ------------------------------------------------------------
    // 7) Render function (applies filter + sorting)
    // ------------------------------------------------------------
    function render() {
      var selected = categorySelect.value;

      // Filter (no ALL)
      var filtered = data.filter(function (r) {
        return (r["Product Type"] || "") === selected;
      });

      // Sort (Total Terpenes desc, then BetaCaryphyllene desc)
      filtered.sort(function(a, b) {
        if (b["Total Terpenes"] !== a["Total Terpenes"]) return b["Total Terpenes"] - a["Total Terpenes"];
        return toNum(b["BetaCaryphyllene"]) - toNum(a["BetaCaryphyllene"]);
      });

      // Render rows
      var tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      for (var r = 0; r < filtered.length; r++) {
        var row2 = filtered[r];
        var tr = document.createElement("tr");

        // base columns
        for (var bc = 0; bc < baseCols.length; bc++) {
          var col = baseCols[bc];
          var td = document.createElement("td");

          if (col.type === "txt") {
            td.className = "txt";
            td.textContent = row2[col.key] || "";
          } else if (col.type === "num_pct") {
            td.className = "num";
            td.textContent = fmtPct(row2[col.key]);
          }
          tr.appendChild(td);
        }

        // terp columns
        for (var tt = 0; tt < terpCols.length; tt++) {
          var td2 = document.createElement("td");
          td2.className = "num";
          td2.textContent = fmtPct(row2[terpCols[tt]]);
          tr.appendChild(td2);
        }

        tbody.appendChild(tr);
      }

      setStatus("running", "JS status: RUNNING ✅ (category: " + selected + " • rows: " + filtered.length + ")");
    }

    categorySelect.addEventListener("change", render);

    // Initial render (default Flower)
    render();

  } catch (e) {
    console.error(e);
    setStatus("error", "JS ERROR: " + e.message);
  }
});
</script>

</body>
</html>
